{% extends "admin_base.html" %}

{% block title %}
Customers
{% endblock %}

{% block content %}
<div id="wrapper">
    <h1>Customers</h1>
    <form id="search-form" onsubmit="event.preventDefault(); searchCustomers();">
        <input type="text" id="search-query" placeholder="Search customers...">
        <button type="submit" class="btn">Search</button>
    </form>
    <table id="customers-table">
        <thead>
            <tr>
                <th onclick="sortCustomers('person_id')">Person ID</th>
                <th onclick="sortCustomers('first_name')">First Name</th>
                <th onclick="sortCustomers('last_name')">Last Name</th>
                <th onclick="sortCustomers('email')">Email</th>
                <th>Addresses</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
            <tr id="row-{{ customer.person_id }}">
                <td>{{ customer.person_id }}</td>
                <td>
                    <span id="first_name-{{ customer.person_id }}-text">{{ customer.first_name }}</span>
                    <input type="text" id="first_name-{{ customer.person_id }}-input" value="{{ customer.first_name }}" style="display:none; width: 100px;">
                </td>
                <td>
                    <span id="last_name-{{ customer.person_id }}-text">{{ customer.last_name }}</span>
                    <input type="text" id="last_name-{{ customer.person_id }}-input" value="{{ customer.last_name }}" style="display:none; width: 100px;">
                </td>
                <td>
                    <span id="email-{{ customer.person_id }}-text">{{ customer.email }}</span>
                    <input type="text" id="email-{{ customer.person_id }}-input" value="{{ customer.email }}" style="display:none; width: 100px;">
                </td>
                <td>
                    <table class="address-subtable">
                        <thead>
                            <tr>
                                <th>Street Address</th>
                                <th>City</th>
                                <th>Zip Code</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for address in customer.addresses %}
                            <tr id="address-row-{{ address.id }}">
                                <td>
                                    <span id="street_address-{{ address.id }}-text">{{ address.street_address }}</span>
                                    <input type="text" id="street_address-{{ address.id }}-input" value="{{ address.street_address }}" style="display:none; width: 100px;">
                                </td>
                                <td>
                                    <span id="city-{{ address.id }}-text">{{ address.city }}</span>
                                    <input type="text" id="city-{{ address.id }}-input" value="{{ address.city }}" style="display:none; width: 100px;">
                                </td>
                                <td>
                                    <span id="zip_code-{{ address.id }}-text">{{ address.zip_code }}</span>
                                    <input type="text" id="zip_code-{{ address.id }}-input" value="{{ address.zip_code }}" style="display:none; width: 100px;">
                                </td>
                                <td class="action-buttons">
                                    <button id="edit-address-btn-{{ address.id }}" class="edit" onclick="enableEditAddress({{ address.id }})">Edit</button>
                                    <button id="save-address-btn-{{ address.id }}" class="save" style="display:none;" onclick="saveEditAddress({{ address.id }})">Save</button>
                                    <button class="delete" onclick="deleteAddress({{ address.id }})">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
                <td class="action-buttons">
                    <button id="edit-btn-{{ customer.person_id }}" class="edit" onclick="enableEdit({{ customer.person_id }})">Edit</button>
                    <button id="save-btn-{{ customer.person_id }}" class="save" style="display:none;" onclick="saveEdit({{ customer.person_id }})">Save</button>
                    <button class="delete" onclick="deleteCustomer({{ customer.person_id }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="btn-container">
        <button onclick="window.location.href='{{ url_for('add_customer') }}'" class="btn">Add Customer</button>
    </div>
</div>


<style>
    /* Existing styles */
    table {
        width: 80%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    th {
        background-color: #f4f4f4;
        cursor: pointer;
        text-align: center;
    }
    tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    tr:hover {
        background-color: #f1f1f1;
    }
    .btn-container {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    .btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
    }
    .btn:hover {
        background-color: #0056b3;
    }
    .edit, .delete, .save {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
    }
    .edit:hover, .delete:hover, .save:hover {
        background-color: #0056b3;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    /* Styles for the address subtable */
    .address-subtable {
        width: 100%;
        border: 1px solid #ddd;
        margin-top: 10px;
    }
    .address-subtable th, .address-subtable td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .address-subtable th {
        background-color: #e9ecef;
        text-align: center;
    }
    .address-subtable tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    .address-subtable tr:hover {
        background-color: #e2e6ea;
    }
</style>


<script>
    /* Existing JavaScript functions */
    function enableEditAddress(address_id) {
        console.log('Enabling edit for address ID:', address_id);
        var row = document.getElementById('address-row-' + address_id);
        row.classList.add('edit-mode');
        document.getElementById('street_address-' + address_id + '-text').style.display = 'none';
        document.getElementById('street_address-' + address_id + '-input').style.display = 'inline';
        document.getElementById('city-' + address_id + '-text').style.display = 'none';
        document.getElementById('city-' + address_id + '-input').style.display = 'inline';
        document.getElementById('zip_code-' + address_id + '-text').style.display = 'none';
        document.getElementById('zip_code-' + address_id + '-input').style.display = 'inline';
        document.getElementById('save-address-btn-' + address_id).style.display = 'inline';
        document.getElementById('edit-address-btn-' + address_id).style.display = 'none';
    }

    function saveEditAddress(address_id) {
        console.log('Saving edit for address ID:', address_id);
        var street_address = $('#street_address-' + address_id + '-input').val();
        var city = $('#city-' + address_id + '-input').val();
        var zip_code = $('#zip_code-' + address_id + '-input').val();
        $.ajax({
            url: '/update_address/' + address_id,
            type: 'POST',
            data: {
                street_address: street_address,
                city: city,
                zip_code: zip_code
            },
            success: function(response) {
                if (response.success) {
                    $('#street_address-' + address_id + '-text').text(street_address).show();
                    $('#street_address-' + address_id + '-input').hide();
                    $('#city-' + address_id + '-text').text(city).show();
                    $('#city-' + address_id + '-input').hide();
                    $('#zip_code-' + address_id + '-text').text(zip_code).show();
                    $('#zip_code-' + address_id + '-input').hide();
                    $('#edit-address-btn-' + address_id).show();
                    $('#save-address-btn-' + address_id).hide();
                } else {
                    alert('Error updating address: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Error updating address: ' + xhr.responseText);
            }
        });
    }

    function deleteAddress(address_id) {
        console.log('Deleting address ID:', address_id);
        if (confirm('Are you sure you want to delete this address?')) {
            $.ajax({
                url: '/delete_address/' + address_id,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $('#address-row-' + address_id).remove();
                    } else {
                        alert('Error deleting address: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error deleting address: ' + xhr.responseText);
                }
            });
        }
    }

    function searchCustomers() {
        var query = document.getElementById('search-query').value;
        $.ajax({
            url: '/search_customers',
            type: 'GET',
            data: { query: query },
            success: function(response) {
                var tbody = document.querySelector('#customers-table tbody');
                tbody.innerHTML = '';
                response.customers.forEach(function(customer) {
                    var row = document.createElement('tr');
                    row.id = 'row-' + customer.person_id;
                    row.innerHTML = `
                        <td>${customer.person_id}</td>
                        <td>
                            <span id="first_name-${customer.person_id}-text">${customer.first_name}</span>
                            <input type="text" id="first_name-${customer.person_id}-input" value="${customer.first_name}" style="display:none; width: 100px;">
                        </td>
                        <td>
                            <span id="last_name-${customer.person_id}-text">${customer.last_name}</span>
                            <input type="text" id="last_name-${customer.person_id}-input" value="${customer.last_name}" style="display:none; width: 100px;">
                        </td>
                        <td>
                            <span id="email-${customer.person_id}-text">${customer.email}</span>
                            <input type="text" id="email-${customer.person_id}-input" value="${customer.email}" style="display:none; width: 100px;">
                        </td>
                        <td>
                            <table class="address-subtable">
                                <thead>
                                    <tr>
                                        <th>Street Address</th>
                                        <th>City</th>
                                        <th>Zip Code</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customer.addresses.map(address => `
                                        <tr id="address-row-${address.id}">
                                            <td>
                                                <span id="street_address-${address.id}-text">${address.street_address}</span>
                                                <input type="text" id="street_address-${address.id}-input" value="${address.street_address}" style="display:none; width: 100px;">
                                            </td>
                                            <td>
                                                <span id="city-${address.id}-text">${address.city}</span>
                                                <input type="text" id="city-${address.id}-input" value="${address.city}" style="display:none; width: 100px;">
                                            </td>
                                            <td>
                                                <span id="zip_code-${address.id}-text">${address.zip_code}</span>
                                                <input type="text" id="zip_code-${address.id}-input" value="${address.zip_code}" style="display:none; width: 100px;">
                                            </td>
                                            <td class="action-buttons">
                                                <button id="edit-address-btn-${address.id}" class="edit" onclick="enableEditAddress(${address.id})">Edit</button>
                                                <button id="save-address-btn-${address.id}" class="save" style="display:none;" onclick="saveEditAddress(${address.id})">Save</button>
                                                <button class="delete" onclick="deleteAddress(${address.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                        <td class="action-buttons">
                            <button id="edit-btn-${customer.person_id}" class="edit" onclick="enableEdit(${customer.person_id})">Edit</button>
                            <button id="save-btn-${customer.person_id}" class="save" style="display:none;" onclick="saveEdit(${customer.person_id})">Save</button>
                            <button class="delete" onclick="deleteCustomer(${customer.person_id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },
            error: function(xhr, status, error) {
                alert('Error searching customers: ' + xhr.responseText);
            }
        });
    }
</script>
{% endblock %}